import React, { useState, useEffect, useCallback, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, onSnapshot, setDoc } from 'firebase/firestore';
import { ChevronDown, Search, MessageCircle, Calculator, BookOpen, LogOut, Menu, X, AlertTriangle, CheckCircle, Info, PlusCircle, Edit3, Trash2, User, Heart, Brain, Bone, Shield, Zap, Leaf, Droplet, Utensils, Weight, Ruler, Activity, Target, Moon, Sun, CalendarDays, Percent, HelpCircle, AlignLeft, ListChecks, TestTube2, Pill, AlertCircleIcon, LinkIcon, Lightbulb, BookMarkedIcon, EyeIcon, Maximize, Minimize, Sparkles, UserCog, Library, UserPlus } from 'lucide-react';

// Variáveis globais do ambiente (simuladas se não estiverem presentes)
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
    apiKey: "YOUR_API_KEY", // Replace with your actual Firebase config
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'farnutri-merged-app-v2'; 

// Inicialização do Firebase
let app;
let auth;
let db;

try {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
} catch (error) {
    console.error("Erro ao inicializar Firebase:", error);
    if (document.getElementById('root')) {
        document.getElementById('root').innerHTML = `
            <div style="padding: 20px; text-align: center; font-family: sans-serif; color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px;">
                <h2>Erro Crítico</h2>
                <p>Não foi possível conectar aos nossos serviços. Por favor, tente recarregar a página ou contate o suporte se o problema persistir.</p>
                <p>Detalhe: ${error.message}</p>
            </div>
        `;
    }
}


// Helper function from HTML
const extractColorsFromPlaceholder = (url) => {
    if (!url) return { bgColor: '#f3f4f6', textColor: '#374151' };
    const match = url.match(/\/([a-fA-F0-9]{6})\/([a-fA-F0-9]{6})\?text=/);
    if (match && match.length === 3) {
        return { bgColor: `#${match[1]}`, textColor: `#${match[2]}` };
    }
    return { bgColor: '#f3f4f6', textColor: '#374151' };
};

// Custom Styles from HTML
// Removed jsx="true" and global="true" from style tag.
// Note: @apply directives inside this style tag will likely not work without a build step (PostCSS).
// For full Tailwind functionality with custom classes, define them in a global CSS file processed by Tailwind,
// or apply Tailwind classes directly in JSX. This change is primarily to fix the React rendering error.
const GlobalStyles = () => (
    <style>{`
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: #FFF1F2; color: #1e293b; /* bg-rose-50 text-slate-800 */ }
        
        .hero-bg-custom { 
            background: linear-gradient(to right, #e11d48, #be123c); 
            padding-top: 5rem; /* py-20 */
            padding-bottom: 5rem; /* py-20 */
            position: relative; 
            overflow: hidden; 
        }
        @media (min-width: 768px) {
            .hero-bg-custom {
                padding-top: 7rem; /* md:py-28 */
                padding-bottom: 7rem; /* md:py-28 */
            }
        }
        .hero-bg-custom::before { 
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(circle at 100% 150%, rgba(255,255,255,0.1) 0%, transparent 70%), radial-gradient(circle at 0% -50%, rgba(255,255,255,0.1) 0%, transparent 70%);
            opacity: 0.3; z-index: 0;
        }
        .hero-bg-custom > .container { position: relative; z-index: 1; }
        .hero-bg-custom .hero-title-custom { 
             font-size: 3rem; /* text-5xl */
             line-height: 1.1;
             font-weight: 800; /* font-extrabold */
             margin-bottom: 1.5rem; /* mb-6 */
             letter-spacing: -0.025em; /* tracking-tight */
             text-shadow: 0 2px 4px rgba(0,0,0,0.3); /* drop-shadow-lg */
        }
         @media (min-width: 640px) { /* sm:text-6xl */
            .hero-bg-custom .hero-title-custom { font-size: 3.75rem; }
        }
        @media (min-width: 768px) { /* md:text-7xl */
            .hero-bg-custom .hero-title-custom { font-size: 4.5rem; }
        }

        .hero-bg-custom .hero-subtitle-custom { 
            font-size: 1.125rem; /* text-lg */
            line-height: 1.75rem;
            margin-bottom: 3rem; /* mb-12 */
            max-width: 48rem; /* max-w-3xl */
            margin-left: auto;
            margin-right: auto;
            line-height: 1.625; /* leading-relaxed */
            opacity: 0.95; 
        }
         @media (min-width: 768px) { /* md:text-xl */
            .hero-bg-custom .hero-subtitle-custom { font-size: 1.25rem; line-height: 1.75rem; }
        }

        .hero-bg-custom .cta-button-hero { 
            background-color: #ffffff; /* bg-white */
            color: #be123c; /* text-red-700 */
            font-weight: 700; /* font-bold */
            padding: 1rem 2.5rem; /* py-4 px-10 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); /* shadow-xl */
            transition: all 0.3s ease-in-out;
            font-size: 1.125rem; /* text-lg */
            border-width: 2px;
            border-color: #ffe4e6; /* border-rose-200 */
        }
        .hero-bg-custom .cta-button-hero:hover {
            background-color: #fff1f2; /* hover:bg-rose-50 */
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); /* hover:shadow-2xl */
            transform: scale(1.05); /* hover:scale-105 */
            border-color: #ffffff; /* hover:border-white */
        }
        
        .hero-bg-custom .disclaimer-box-hero { 
            background-color: rgba(255,255,255,0.2); /* bg-white/20 */
            backdrop-filter: blur(10px); /* backdrop-blur-md */
            border: 1px solid rgba(255,255,255,0.3); /* border-white/30 */
            padding: 1.5rem; /* p-6 */
            border-radius: 1.5rem; 
            margin-top: 4rem; /* mt-16 */
            max-width: 56rem; /* max-w-4xl */
            margin-left: auto;
            margin-right: auto;
            text-align: left;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); /* shadow-xl */
        }
      
        .section-title-custom { 
            font-size: 2.25rem; /* text-4xl */
            line-height: 2.5rem;
            font-weight: 800; /* font-extrabold */
            text-align: center;
            margin-bottom: 1rem; /* mb-4 */
            color: #be123c; /* text-red-700 */
        }
        .section-title-custom.large-bold { font-size: 3rem; /* text-5xl */ line-height: 1; font-weight: 900; } 
        .section-title-custom.red-bold-large { color: #be123c; font-size: 3rem; line-height: 1; font-weight: 800; }


        .section-title-subtle-custom { 
            text-align: center; 
            color: #475569; /* text-slate-600 */
            margin-bottom: 4rem; /* mb-16 */
            font-size: 1.125rem; /* text-lg */
            line-height: 1.75rem;
            max-width: 42rem; /* max-w-2xl */
            margin-left: auto;
            margin-right: auto;
            line-height: 1.625; /* leading-relaxed */
        }
        
        .suplemento-detalhe-content-custom h3 { font-size: 1.5rem; line-height: 2rem; font-weight: 700; color: #be123c; margin-bottom: 1.25rem; margin-top: 2rem; }
        .suplemento-detalhe-content-custom h3:first-child { margin-top: 0; }
        .suplemento-detalhe-content-custom h4 { font-size: 1.25rem; line-height: 1.75rem; font-weight: 600; color: #dc2626; margin-top: 1.5rem; margin-bottom: 0.75rem; }
        .suplemento-detalhe-content-custom p, .suplemento-detalhe-content-custom li { margin-bottom: 0.75rem; line-height: 1.625; color: #334155; }
        .suplemento-detalhe-content-custom ul, .suplemento-detalhe-content-custom ol { list-style-type: disc; list-style-position: inside; padding-left: 0.75rem; margin-bottom: 0.75rem; }
        .suplemento-detalhe-content-custom ul li, .suplemento-detalhe-content-custom ol li { margin-bottom: 0.375rem; }


        .content-box-custom { background-color: #ffffff; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); margin-bottom: 3rem; }
         @media (min-width: 768px) { .content-box-custom { padding: 2.5rem; } }

        .biblioteca-suplemento-card {
            background-image: linear-gradient(to bottom right, #ef4444, #be123c); /* from-rose-500 to-red-700 */
            padding: 0.25rem; /* p-1 */
            border-radius: 1rem; /* rounded-2xl */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); /* shadow-xl */
            transition: all 0.3s ease-in-out;
            transform: scale(1);
            min-height: 200px; 
        }
        .biblioteca-suplemento-card:hover {
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); /* hover:shadow-2xl */
            transform: scale(1.05); /* hover:scale-105 */
        }
        .biblioteca-suplemento-card-inner {
            background-color: rgba(255,255,255,0.9); /* bg-white/90 */
            backdrop-filter: blur(4px); /* backdrop-blur-sm */
            border-radius: 0.875rem; /* Matches outer rounded-xl after p-1 */
            height: 100%; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem; /* p-6 */
            text-align: center;
            cursor: pointer;
        }
        .biblioteca-suplemento-card-title {
            font-size: 1.5rem; /* text-2xl */
            line-height: 2rem;
            font-weight: 800; /* font-extrabold */
            color: #be123c; /* text-red-700 */
            line-height: 1.25; /* leading-tight */
            text-shadow: 0 1px 2px rgba(0,0,0,0.1); /* drop-shadow-sm */
        }
         @media (min-width: 768px) { .biblioteca-suplemento-card-title { font-size: 1.875rem; line-height: 2.25rem; } } /* md:text-3xl */
         .biblioteca-suplemento-card:hover .biblioteca-suplemento-card-title {
            color: #dc2626; /* text-red-500 */
        }


        .suplemento-card-custom { position: relative; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); overflow: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: all 0.3s ease-in-out; min-height: 180px; }
        .suplemento-card-custom::before { 
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.4) 100%); 
            z-index: 1; opacity: 0; transition: opacity 0.3s ease-in-out; 
        }
        .suplemento-card-custom:hover::before { opacity: 1; }
        .suplemento-card-content-custom { position: relative; z-index: 20; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 1rem; text-align: center; }
        .suplemento-card-title-custom { font-size: 1.875rem; line-height: 2.25rem; font-weight: 800; line-height: 1.25; text-shadow: 0 2px 4px rgba(0,0,0,0.5); transition: transform 0.3s ease-in-out; }
         @media (min-width: 768px) { .suplemento-card-title-custom { font-size: 2.25rem; line-height: 2.5rem; } } /* md:text-4xl */
        .suplemento-card-custom:hover .suplemento-card-title-custom { transform: translateY(-5px); }

        .cta-button-custom { background-color: #dc2626; color: #ffffff; font-weight: 600; padding: 0.875rem 1.75rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); transition: all 0.3s ease-in-out; display: inline-flex; align-items: center; justify-content: center; font-size: 1rem; line-height: 1.5rem; transform: scale(1); }
        .cta-button-custom:hover { background-color: #be123c; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); transform: scale(1.05); }
        
        .cta-button-catalogo-pessoal {
            background-image: linear-gradient(to right, #ef4444, #ec4899); /* from-red-500 to-rose-600 */
            color: #ffffff; font-weight: 700; padding: 1rem 2rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); transition: all 0.3s ease-in-out; display: inline-flex; align-items: center; justify-content: center; font-size: 1.125rem; line-height: 1.75rem; transform: scale(1);
        }
        .cta-button-catalogo-pessoal:hover {
             background-image: linear-gradient(to right, #dc2626, #db2777); /* hover:from-red-600 hover:to-rose-700 */
             box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); transform: scale(1.05);
        }


        .disclaimer-box-custom { background-color: #fffbeb; border-left: 4px solid #f59e0b; color: #92400e; padding: 1.25rem; border-radius: 0.5rem; margin-top: 1.5rem; margin-bottom: 1.5rem; font-size: 0.875rem; line-height: 1.25rem; line-height: 1.625; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); }
        .disclaimer-box-strong-custom { background-color: #fdf2f8; border-left: 4px solid #db2777; color: #831843; padding: 1.25rem; border-radius: 0.5rem; margin-top: 1.5rem; margin-bottom: 1.5rem; font-weight: 500; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); }
        .disclaimer-box-strong-custom p:first-child { font-size: 1.125rem; line-height: 1.75rem; font-weight: 700; color: #831843; }
        .disclaimer-box-strong-custom.large-title { font-size: 1.5rem; line-height: 2rem; font-weight: 700; margin-bottom: 0.75rem; } 


        .assistente-form-container-custom { background-color: #ffffff; padding: 2rem; border-radius: 1.5rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); max-width: 48rem; margin-left: auto; margin-right: auto; border: 1px solid #ffe4e6; }
         @media (min-width: 768px) { .assistente-form-container-custom { padding: 3rem; } }
        .assistente-resultado-container-custom { margin-top: 2rem; background-color: #fff1f2; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid #fecdd3; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); color: #334155; }
        .assistente-resultado-container-custom strong { color: #be123c; }

        .voltar-catalogo-btn-custom { margin-bottom: 2.5rem; color: #dc2626; font-weight: 600; display: inline-flex; align-items: center; transition: color 0.2s ease-in-out; font-size: 1rem; line-height: 1.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem; background-color: #fee2e2; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); }
        .voltar-catalogo-btn-custom:hover { color: #be123c; background-color: #fecdd3; }
        .voltar-catalogo-btn-custom svg { margin-right: 0.625rem; height: 1.25rem; width: 1.25rem; }

        .suplemento-detalhe-header-block-custom { text-align: center; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); display: flex; align-items: center; justify-content: center; min-height: 200px; }
        .suplemento-detalhe-header-block-custom h2 { color: #ffffff; font-size: 3rem; line-height: 1; font-weight: 800; line-height: 1.25; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
         @media (min-width: 640px) { .suplemento-detalhe-header-block-custom h2 { font-size: 3.75rem; line-height: 1; } } /* sm:text-6xl */
         @media (min-width: 768px) { .suplemento-detalhe-header-block-custom h2 { font-size: 4.5rem; line-height: 1; } } /* md:text-7xl */
         @media (min-width: 1024px) { .suplemento-detalhe-header-block-custom h2 { font-size: 6rem; line-height: 1; } } /* lg:text-8xl */
        
        .loader-custom { border: 4px solid #fdf2f2; border-top: 4px solid #e11d48; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #ffe4e6; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #f43f5e; border-radius: 10px; border: 2px solid #ffe4e6; }
        ::-webkit-scrollbar-thumb:hover { background: #e11d48; }

        .prose-gemini h1 { font-size: 1.5rem; line-height: 2rem; font-weight: 700; color: #be123c; margin-bottom: 0.75rem; }
        .prose-gemini h2 { font-size: 1.25rem; line-height: 1.75rem; font-weight: 600; color: #dc2626; margin-bottom: 0.5rem; margin-top: 1rem; }
        .prose-gemini h3 { font-size: 1.125rem; line-height: 1.75rem; font-weight: 500; color: #ef4444; margin-bottom: 0.5rem; margin-top: 0.75rem; }
        .prose-gemini p { margin-bottom: 0.5rem; color: #334155; font-size: 0.875rem; line-height: 1.25rem; line-height: 1.625; }
        .prose-gemini ul, .prose-gemini ol { list-style-type: disc; list-style-position: inside; padding-left: 1rem; margin-bottom: 0.5rem; font-size: 0.875rem; line-height: 1.25rem; }
        .prose-gemini ul li, .prose-gemini ol li { margin-bottom: 0.25rem; }
        .prose-gemini strong { font-weight: 600; color: #be123c; }
        .prose-gemini a { color: #dc2626; text-decoration: underline; }
        .prose-gemini a:hover { color: #9f1239; }
    `}</style>
);

// --- Components ---

// Header Component
const Header = ({ currentSection, onNavigate, isMobileMenuOpen, setIsMobileMenuOpen, headerRef }) => {
    const navLinks = [
        { id: 'inicio', label: 'Início', icon: <Sun size={18} /> },
        { id: 'biblioteca', label: 'Biblioteca', icon: <Library size={18} /> },
        { id: 'catalogoPessoal', label: 'Catálogo Pessoal', icon: <BookOpen size={18} /> },
        { id: 'interacoes', label: 'Interações (IA)', icon: <Sparkles size={18} /> },
        { id: 'nutricao', label: 'Nutrição', icon: <Calculator size={18} /> },
        { id: 'adicionarSuplemento', label: 'Adicionar Suplemento', icon: <PlusCircle size={18} /> },
        { id: 'sobre', label: 'Sobre', icon: <Info size={18} /> },
    ];

    return (
        <header ref={headerRef} className="bg-white/95 backdrop-blur-lg shadow-xl sticky top-0 z-50 border-b border-rose-100">
            <nav className="container mx-auto px-4 lg:px-6 py-4">
                <div className="flex flex-wrap justify-between items-center">
                    <a href="#inicio" onClick={(e) => onNavigate(e, 'inicio')} className="flex items-center group">
                        <Leaf className="h-9 w-9 text-red-600 mr-2.5 group-hover:text-red-500 transition-colors duration-300" />
                        <span className="text-2xl font-extrabold text-red-700 group-hover:text-red-600 transition-colors duration-300">FarNutri</span>
                    </a>
                    <button
                        onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
                        type="button"
                        className="inline-flex items-center p-2.5 ml-3 text-sm text-slate-500 rounded-lg md:hidden hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-slate-200 transition-colors"
                        aria-controls="mobile-menu"
                        aria-expanded={isMobileMenuOpen}
                    >
                        <span className="sr-only">Abrir menu principal</span>
                        {isMobileMenuOpen ? <X className="w-6 h-6" /> : <Menu className="w-6 h-6" />}
                    </button>
                    <div className={`${isMobileMenuOpen ? 'block' : 'hidden'} w-full md:block md:w-auto`} id="mobile-menu">
                        <ul className="flex flex-col mt-4 md:flex-row md:space-x-1 md:mt-0 md:text-sm">
                            {navLinks.map(link => (
                                <li key={link.id}>
                                    <a
                                        href={`#${link.id}`}
                                        onClick={(e) => { onNavigate(e, link.id); setIsMobileMenuOpen(false); }}
                                        className={`flex items-center px-3 py-2 rounded-lg text-sm font-semibold transition-all duration-200 ease-in-out
                                            ${currentSection === link.id 
                                                ? 'bg-red-100 text-red-700 shadow-md transform scale-105' 
                                                : 'text-slate-700 hover:text-red-600 hover:bg-slate-50'}`}
                                    >
                                        {link.icon && React.cloneElement(link.icon, {className: "mr-1.5"})}
                                        {link.label}
                                    </a>
                                </li>
                            ))}
                        </ul>
                    </div>
                </div>
            </nav>
        </header>
    );
};

// Hero Section
const HeroSection = ({ id, onNavigate }) => (
    <section id={id} className="hero-bg-custom">
        <div className="container mx-auto px-4 text-center">
            <h1 className="hero-title-custom text-white">FarNutri: Seu guia suplementativo</h1> 
            <p className="hero-subtitle-custom text-rose-100">Informações detalhadas e ferramentas úteis sobre suplementos alimentares, baseadas em evidências científicas e dados regulatórios. Capacite suas escolhas!</p>
            <a href="#biblioteca" onClick={(e) => onNavigate(e, 'biblioteca')} className="cta-button-hero">
                Explorar Biblioteca
            </a>
            <div className="disclaimer-box-hero">
                <h2 className="font-semibold text-2xl mb-4 text-white">⚠️ Atenção Fundamental:</h2>
                <p className="text-base leading-relaxed text-rose-100 opacity-95">O FarNutri é uma ferramenta de caráter exclusivamente educativo. As informações e calculadoras aqui apresentadas <strong className="text-white">NÃO substituem, em hipótese alguma, a avaliação, diagnóstico, tratamento ou orientação de um profissional de saúde qualificado</strong> (médico, nutricionista, farmacêutico).</p>
                <p className="mt-3 text-base leading-relaxed text-rose-100 opacity-95">Antes de usar qualquer suplemento, modificar sua dieta ou rotina, <strong className="text-white">CONSULTE SEMPRE UM PROFISSIONAL DE SAÚDE</strong>. A automedicação e o uso inadequado de suplementos podem ser prejudiciais.</p>
            </div>
        </div>
    </section>
);

// --- Data for Biblioteca Section ---
const dadosBiblioteca = [
    { nome: "Creatina", id: "creatina_bib", imagemPlaceholder: "https://placehold.co/600x400/E11D48/FFFFFF?text=Creatina", htmlDetalhes: `<h3>O que é a Creatina?</h3> <p>A creatina é um aminoácido encontrado em alimentos como carnes e sintetizado no corpo. Essencial para energia muscular rápida.</p> <h4>Principais Benefícios</h4> <ul><li>Melhora do desempenho em exercícios de alta intensidade.</li><li>Aumento de força e massa muscular.</li></ul> <h4>Posologia Comum</h4> <p>Fase de saturação (opcional): 20g/dia por 5-7 dias. Manutenção: 3-5g/dia.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Whey Protein", id: "whey_bib", imagemPlaceholder: "https://placehold.co/600x400/BE123C/FFFFFF?text=Whey+Protein", htmlDetalhes: `<h3>O que é o Whey Protein?</h3> <p>Proteína do soro do leite, rica em aminoácidos essenciais, especialmente BCAAs. Usada para recuperação e construção muscular.</p> <h4>Principais Benefícios</h4> <ul><li>Auxilia na hipertrofia muscular.</li><li>Melhora a recuperação pós-treino.</li></ul> <h4>Posologia Comum</h4> <p>20-40g pós-treino ou conforme necessidade proteica diária.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "BCAA", id: "bcaa_bib", imagemPlaceholder: "https://placehold.co/600x400/9F1239/FFFFFF?text=BCAA", htmlDetalhes: `<h3>O que são os BCAAs?</h3> <p>Aminoácidos de Cadeia Ramificada (Leucina, Isoleucina, Valina). Importantes para síntese proteica e energia muscular.</p> <h4>Principais Benefícios</h4> <ul><li>Podem reduzir a fadiga muscular.</li><li>Auxiliam na recuperação.</li></ul> <p><em>Nota: A suplementação isolada de BCAA pode não ser tão eficaz quanto proteínas completas para a síntese proteica máxima.</em></p> <h4>Posologia Comum</h4> <p>5-10g antes, durante ou após o treino.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Glutamina", id: "glutamina_bib", imagemPlaceholder: "https://placehold.co/600x400/7F1D1D/FFFFFF?text=Glutamina", htmlDetalhes: `<h3>O que é a Glutamina?</h3> <p>Aminoácido abundante no corpo, importante para o sistema imunológico e saúde intestinal, especialmente em períodos de estresse.</p> <h4>Principais Benefícios</h4> <ul><li>Suporte ao sistema imunológico.</li><li>Pode auxiliar na recuperação muscular e saúde intestinal.</li></ul> <h4>Posologia Comum</h4> <p>5-15g por dia, fracionados.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "L-Carnitina", id: "lcarnitina_bib", imagemPlaceholder: "https://placehold.co/600x400/881337/FFFFFF?text=L-Carnitina", htmlDetalhes: `<h3>O que é a L-Carnitina?</h3> <p>Composto que auxilia no transporte de ácidos graxos para as mitocôndrias, onde são convertidos em energia.</p> <h4>Principais Benefícios</h4> <ul><li>Pode auxiliar no metabolismo de gorduras.</li><li>Pode melhorar o desempenho e recuperação em algumas situações.</li></ul> <h4>Posologia Comum</h4> <p>1-3g por dia.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Beta-Alanina", id: "betaalanina_bib", imagemPlaceholder: "https://placehold.co/600x400/e0f2f7/374151?text=Beta-Alanina", htmlDetalhes: `<h3>O que é a Beta-Alanina?</h3> <p>Aminoácido que aumenta os níveis de carnosina muscular, ajudando a tamponar a acidez e retardar a fadiga.</p> <h4>Principais Benefícios</h4> <ul><li>Melhora o desempenho em exercícios de alta intensidade (1-4 minutos).</li><li>Reduz a fadiga muscular.</li></ul> <h4>Posologia Comum</h4> <p>3-6g por dia, fracionados para evitar parestesia (formigamento).</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Arginina", id: "arginina_bib", imagemPlaceholder: "https://placehold.co/600x400/fecdd3/374151?text=Arginina", htmlDetalhes: `<h3>O que é a Arginina?</h3> <p>Aminoácido precursor do óxido nítrico (NO), que promove vasodilatação e melhora o fluxo sanguíneo.</p> <h4>Principais Benefícios</h4> <ul><li>Pode melhorar o fluxo sanguíneo e entrega de nutrientes.</li><li>Potencial para melhora de desempenho em alguns casos.</li></ul> <h4>Posologia Comum</h4> <p>3-6g antes do treino.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Ômega 3", id: "omega3_bib", imagemPlaceholder: "https://placehold.co/600x400/fee2e2/374151?text=Ômega+3", htmlDetalhes: `<h3>O que é o Ômega 3?</h3> <p>Ácidos graxos essenciais (EPA e DHA) com propriedades anti-inflamatórias, importantes para saúde cardiovascular e cerebral.</p> <h4>Principais Benefícios</h4> <ul><li>Saúde cardiovascular.</li><li>Função cerebral e visual.</li><li>Ação anti-inflamatória.</li></ul> <h4>Posologia Comum</h4> <p>1-3g de EPA+DHA combinados por dia.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Cafeína", id: "cafeina_bib", imagemPlaceholder: "https://placehold.co/600x400/fecdd3/374151?text=Cafeína", htmlDetalhes: `<h3>O que é a Cafeína?</h3> <p>Estimulante do sistema nervoso central que aumenta o alerta, foco e pode melhorar o desempenho físico.</p> <h4>Principais Benefícios</h4> <ul><li>Aumento de energia e alerta.</li><li>Melhora do desempenho físico e mental.</li></ul> <h4>Posologia Comum</h4> <p>100-400mg, 30-60 minutos antes do exercício ou conforme necessidade. Evitar altas doses e uso tardio.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Multivitamínico", id: "multivitaminico_bib", imagemPlaceholder: "https://placehold.co/600x400/fecdd3/374151?text=Multivitamínico", htmlDetalhes: `<h3>O que é um Multivitamínico?</h3> <p>Suplemento que combina diversas vitaminas e minerais essenciais para complementar a dieta e prevenir deficiências.</p> <h4>Principais Benefícios</h4> <ul><li>Ajuda a suprir lacunas nutricionais.</li><li>Suporte geral à saúde.</li></ul> <h4>Posologia Comum</h4> <p>Conforme rótulo do produto. Idealmente com orientação profissional.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Probióticos", id: "probioticos_bib", imagemPlaceholder: "https://placehold.co/600x400/fbcfe8/374151?text=Probióticos", htmlDetalhes: `<h3>O que são Probióticos?</h3> <p>Microrganismos vivos que, administrados em quantidades adequadas, conferem benefícios à saúde, especialmente intestinal.</p> <h4>Principais Benefícios</h4> <ul><li>Saúde digestiva e intestinal.</li><li>Fortalecimento do sistema imunológico.</li></ul> <h4>Posologia Comum</h4> <p>Varia conforme a cepa e o produto. Seguir recomendação do fabricante ou profissional.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Fibras Dietéticas", id: "fibras_bib", imagemPlaceholder: "https://placehold.co/600x400/fee2e2/374151?text=Fibras", htmlDetalhes: `<h3>O que são Fibras Dietéticas?</h3> <p>Componentes de alimentos vegetais não digeríveis, importantes para a saúde digestiva, saciedade e controle glicêmico.</p> <h4>Principais Benefícios</h4> <ul><li>Melhora o trânsito intestinal.</li><li>Aumenta a saciedade.</li><li>Auxilia no controle do colesterol e glicemia.</li></ul> <h4>Recomendação</h4> <p>Aumentar o consumo através de frutas, vegetais, leguminosas e grãos integrais. Suplementos podem complementar.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Colágeno", id: "colageno_bib", imagemPlaceholder: "https://placehold.co/600x400/ffe4e6/374151?text=Colágeno", htmlDetalhes: `<h3>O que é o Colágeno?</h3> <p>Proteína estrutural fundamental para pele, articulações, ossos e tecidos conjuntivos.</p> <h4>Principais Benefícios</h4> <ul><li>Pode melhorar a saúde da pele e elasticidade.</li><li>Suporte à saúde articular.</li></ul> <h4>Posologia Comum</h4> <p>Varia conforme o tipo (hidrolisado, tipo II). Geralmente 2.5-15g/dia para colágeno hidrolisado.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Vitamina D", id: "vitaminad_bib", imagemPlaceholder: "https://placehold.co/600x400/ffe4b5/374151?text=Vitamina+D", htmlDetalhes: `<h3>O que é a Vitamina D?</h3> <p>Vitamina lipossolúvel essencial para absorção de cálcio, saúde óssea, função imunológica e muscular.</p> <h4>Principais Benefícios</h4> <ul><li>Saúde óssea e dental.</li><li>Fortalecimento do sistema imunológico.</li></ul> <h4>Posologia Comum</h4> <p>Varia conforme níveis sanguíneos e orientação profissional. Exposição solar é a principal fonte.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Magnésio", id: "magnesio_bib", imagemPlaceholder: "https://placehold.co/600x400/fee2e2/374151?text=Magnésio", htmlDetalhes: `<h3>O que é o Magnésio?</h3> <p>Mineral essencial envolvido em centenas de reações enzimáticas, importante para função muscular, nervosa, energia e saúde óssea.</p> <h4>Principais Benefícios</h4> <ul><li>Saúde muscular e nervosa.</li><li>Produção de energia.</li><li>Pode auxiliar no sono e relaxamento.</li></ul> <h4>Posologia Comum</h4> <p>200-400mg por dia, dependendo da forma e necessidade.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Carotenoides", id: "carotenoides_bib", imagemPlaceholder: "https://placehold.co/600x400/fecba1/374151?text=Carotenoides", htmlDetalhes: `<h3>O que são Carotenoides?</h3> <p>Pigmentos vegetais (ex: betacaroteno, luteína, licopeno) com potente ação antioxidante. Alguns são precursores da Vitamina A.</p> <h4>Principais Benefícios</h4> <ul><li>Ação antioxidante.</li><li>Saúde ocular e da pele.</li></ul> <h4>Recomendação</h4> <p>Obtidos através de dieta rica em frutas e vegetais coloridos.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Fitosteróis", id: "fitosterois_bib", imagemPlaceholder: "https://placehold.co/600x400/fee2e2/374151?text=Fitosteróis", htmlDetalhes: `<h3>O que são Fitosteróis?</h3> <p>Compostos vegetais estruturalmente similares ao colesterol, que ajudam a reduzir a absorção de colesterol no intestino.</p> <h4>Principais Benefícios</h4> <ul><li>Auxiliam na redução do colesterol LDL ("ruim").</li></ul> <h4>Posologia Comum</h4> <p>1-3g por dia, geralmente via alimentos enriquecidos ou suplementos.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Coenzima Q10", id: "coq10_bib", imagemPlaceholder: "https://placehold.co/600x400/fca5a5/374151?text=CoQ10", htmlDetalhes: `<h3>O que é a Coenzima Q10?</h3> <p>Substância similar a uma vitamina, essencial para produção de energia celular (ATP) e com forte ação antioxidante.</p> <h4>Principais Benefícios</h4> <ul><li>Produção de energia celular.</li><li>Ação antioxidante.</li><li>Pode beneficiar a saúde cardiovascular.</li></ul> <h4>Posologia Comum</h4> <p>100-200mg por dia. Usuários de estatinas podem necessitar mais.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Resveratrol", id: "resveratrol_bib", imagemPlaceholder: "https://placehold.co/600x400/fda4af/374151?text=Resveratrol", htmlDetalhes: `<h3>O que é o Resveratrol?</h3> <p>Polifenol encontrado em uvas vermelhas e outras plantas, conhecido por suas propriedades antioxidantes e anti-inflamatórias.</p> <h4>Principais Benefícios</h4> <ul><li>Potente ação antioxidante.</li><li>Pode apoiar a saúde cardiovascular e metabólica.</li></ul> <h4>Posologia Comum</h4> <p>Doses variam, geralmente 100-500mg de trans-resveratrol.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Triptofano", id: "triptofano_bib", imagemPlaceholder: "https://placehold.co/600x400/bae6fd/374151?text=Triptofano", htmlDetalhes: `<h3>O que é o Triptofano?</h3> <p>Aminoácido essencial precursor da serotonina (neurotransmissor do bem-estar) e melatonina (hormônio do sono).</p> <h4>Principais Benefícios</h4> <ul><li>Pode melhorar o humor.</li><li>Auxilia na regulação do sono.</li><li>Pode ajudar a controlar o apetite.</li></ul> <h4>Posologia Comum</h4> <p>500mg a 2g por dia, preferencialmente antes de dormir ou conforme orientação.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Ashwagandha", id: "ashwagandha_bib", imagemPlaceholder: "https://placehold.co/600x400/d4d4d8/374151?text=Ashwagandha", htmlDetalhes: `<h3>O que é a Ashwagandha?</h3> <p>Planta adaptógena usada na medicina Ayurveda para ajudar o corpo a lidar com o estresse e promover vitalidade.</p> <h4>Principais Benefícios</h4> <ul><li>Redução do estresse e ansiedade.</li><li>Melhora da energia e resistência.</li><li>Pode apoiar a função cognitiva.</li></ul> <h4>Posologia Comum</h4> <p>300-600mg de extrato padronizado por dia.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Rhodiola Rosea", id: "rhodiola_bib", imagemPlaceholder: "https://placehold.co/600x400/fde68a/374151?text=Rhodiola", htmlDetalhes: `<h3>O que é a Rhodiola Rosea?</h3> <p>Planta adaptógena que cresce em regiões frias, conhecida por combater a fadiga e melhorar o desempenho mental e físico.</p> <h4>Principais Benefícios</h4> <ul><li>Redução da fadiga mental e física.</li><li>Melhora da concentração e humor.</li><li>Aumento da resistência ao estresse.</li></ul> <h4>Posologia Comum</h4> <p>200-600mg de extrato padronizado (ex: 3% rosavinas, 1% salidrosídeos) por dia.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Cúrcuma (Curcumina)", id: "curcuma_bib", imagemPlaceholder: "https://placehold.co/600x400/f59e0b/FFFFFF?text=Cúrcuma", htmlDetalhes: `<h3>O que é a Cúrcuma (Curcumina)?</h3> <p>Especiaria amarela vibrante, cujo principal composto ativo é a curcumina, com potentes efeitos anti-inflamatórios e antioxidantes.</p> <h4>Principais Benefícios</h4> <ul><li>Forte ação anti-inflamatória.</li><li>Poderoso antioxidante.</li><li>Pode melhorar a saúde articular e cerebral.</li></ul> <h4>Posologia Comum</h4> <p>500-2000mg de curcumina por dia, frequentemente combinada com piperina (pimenta preta) para melhor absorção.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Gengibre", id: "gengibre_bib", imagemPlaceholder: "https://placehold.co/600x400/fcd34d/374151?text=Gengibre", htmlDetalhes: `<h3>O que é o Gengibre?</h3> <p>Raiz com propriedades anti-inflamatórias, antioxidantes e digestivas. Usado para aliviar náuseas e dores.</p> <h4>Principais Benefícios</h4> <ul><li>Alívio de náuseas e vômitos.</li><li>Ação anti-inflamatória e analgésica.</li><li>Melhora da digestão.</li></ul> <h4>Posologia Comum</h4> <p>Variável. Em pó: 1-3g por dia. Extratos concentrados conforme orientação.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Tribulus Terrestris", id: "tribulus_bib", imagemPlaceholder: "https://placehold.co/600x400/a3e635/374151?text=Tribulus", htmlDetalhes: `<h3>O que é o Tribulus Terrestris?</h3> <p>Planta usada tradicionalmente para aumentar a libido e, possivelmente, os níveis de testosterona (evidências mistas).</p> <h4>Principais Benefícios</h4> <ul><li>Pode aumentar a libido e função sexual.</li><li>Potencial suporte à vitalidade (mais estudos são necessários).</li></ul> <h4>Posologia Comum</h4> <p>250-1500mg por dia, dependendo da concentração de saponinas.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Valeriana", id: "valeriana_bib", imagemPlaceholder: "https://placehold.co/600x400/c084fc/FFFFFF?text=Valeriana", htmlDetalhes: `<h3>O que é a Valeriana?</h3> <p>Planta medicinal conhecida por suas propriedades calmantes e sedativas, usada para insônia e ansiedade.</p> <h4>Principais Benefícios</h4> <ul><li>Promove o relaxamento e melhora a qualidade do sono.</li><li>Pode reduzir a ansiedade leve.</li></ul> <h4>Posologia Comum</h4> <p>300-600mg de extrato de raiz, 30-60 minutos antes de dormir.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Vitamina K2", id: "vitaminaK2_bib", imagemPlaceholder: "https://placehold.co/600x400/86efac/374151?text=Vitamina+K2", htmlDetalhes: `<h3>O que é a Vitamina K2?</h3> <p>Vitamina lipossolúvel crucial para a saúde óssea (direciona o cálcio para os ossos) e cardiovascular (previne calcificação arterial).</p> <h4>Principais Benefícios</h4> <ul><li>Saúde óssea e prevenção de osteoporose.</li><li>Saúde cardiovascular.</li></ul> <h4>Posologia Comum</h4> <p>100-200mcg por dia (especialmente na forma MK-7).</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
    { nome: "Vitamina C", id: "vitaminaC_bib", imagemPlaceholder: "https://placehold.co/600x400/fdba74/374151?text=Vitamina+C", htmlDetalhes: `<h3>O que é a Vitamina C?</h3> <p>Poderoso antioxidante hidrossolúvel, essencial para o sistema imunológico, produção de colágeno e absorção de ferro.</p> <h4>Principais Benefícios</h4> <ul><li>Fortalecimento do sistema imunológico.</li><li>Ação antioxidante.</li><li>Saúde da pele e cicatrização.</li></ul> <h4>Posologia Comum</h4> <p>500-2000mg por dia. Doses maiores podem ser usadas em certas condições, com orientação.</p> <div class="disclaimer-box-strong-custom mt-8"> <p>Consulte um profissional de saúde.</p> </div>` },
].map(sup => ({...sup, colors: extractColorsFromPlaceholder(sup.imagemPlaceholder) }));


// Biblioteca Section
const BibliotecaSection = ({ id, onNavigate, headerHeight }) => {
    const [selectedSuplemento, setSelectedSuplemento] = useState(null);
    const detalhesContainerRef = useRef(null);

    const handleSelectSuplemento = (suplemento) => {
        setSelectedSuplemento(suplemento);
        setTimeout(() => {
            if (detalhesContainerRef.current) {
                const elementPosition = detalhesContainerRef.current.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerHeight;
                window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
            }
        }, 100);
    };
    
    const handleVoltarBiblioteca = () => {
        setSelectedSuplemento(null);
        const bibliotecaHome = document.getElementById(id);
        if (bibliotecaHome) {
            const offsetPosition = bibliotecaHome.getBoundingClientRect().top + window.pageYOffset - headerHeight;
            window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
        }
    };

    return (
        <section id={id} className="py-20 md:py-24">
            <div className="container mx-auto px-4">
                <h2 className="section-title-custom">Biblioteca de Suplementos</h2>
                <p className="section-title-subtle-custom">
                    Explore informações sobre suplementos comumente utilizados. Clique para detalhes.
                </p>

                {!selectedSuplemento && (
                    <div className="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-x-8 gap-y-10">
                        {dadosBiblioteca.map(sup => (
                            <div 
                                key={sup.id} 
                                className="biblioteca-suplemento-card" 
                                onClick={() => handleSelectSuplemento(sup)}
                            >
                                <div className="biblioteca-suplemento-card-inner">
                                    <h3 className="biblioteca-suplemento-card-title">
                                        {sup.nome}
                                    </h3>
                                </div>
                            </div>
                        ))}
                    </div>
                )}

                {selectedSuplemento && (
                    <div ref={detalhesContainerRef} className="mt-16 md:mt-20">
                        <div className="suplemento-detalhe-content-custom">
                            <button onClick={handleVoltarBiblioteca} className="voltar-catalogo-btn-custom">
                                <ChevronDown className="mr-2.5 h-5 w-5 transform -rotate-90" /> Voltar à Biblioteca
                            </button>
                            <div 
                                className="suplemento-detalhe-header-block-custom"
                                style={{ backgroundColor: selectedSuplemento.colors?.bgColor || '#E11D48' }} 
                            >
                                <h2 style={{ color: selectedSuplemento.colors?.textColor || '#FFFFFF' }}>{selectedSuplemento.nome}</h2>
                            </div>
                            <div className="content-box-custom">
                                <div className="grid md:grid-cols-3 gap-x-10 gap-y-8">
                                    <div className="md:col-span-1">
                                        <img 
                                            src={selectedSuplemento.imagemPlaceholder || 'https://placehold.co/500x667/cccccc/333333?text=Imagem+Indispon%C3%ADvel'} 
                                            alt={`Imagem de ${selectedSuplemento.nome}`}
                                            className="rounded-xl shadow-lg mb-6 w-full object-cover aspect-[3/4]"
                                            onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/500x667/cccccc/333333?text=Imagem+Indispon%C3%ADvel'; }}
                                        />
                                        <div className="disclaimer-box-custom">
                                            <p className="font-semibold">Lembre-se:</p>
                                            <p>Este conteúdo é informativo. Consulte um profissional de saúde antes de usar este suplemento.</p>
                                        </div>
                                    </div>
                                    <div 
                                        className="md:col-span-2 text-slate-700 leading-relaxed"
                                        dangerouslySetInnerHTML={{ __html: selectedSuplemento.htmlDetalhes || "<p>Informações detalhadas não disponíveis.</p>" }}
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </section>
    );
};


// Catalogo Pessoal Section (Formerly CatalogoSection)
const CatalogoPessoalSection = ({ id, db, userId, onNavigate, headerHeight }) => {
    const [suplementos, setSuplementos] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [selectedSuplemento, setSelectedSuplemento] = useState(null);
    const detalhesContainerRef = useRef(null);

    const suplementosPessoaisCollectionPath = `artifacts/${appId}/public/data/suplementos`; 

    useEffect(() => {
        if (!db || !userId) return;
        setLoading(true);
        const suplementosRef = collection(db, suplementosPessoaisCollectionPath);
        const q = query(suplementosRef);
        
        const unsubscribe = onSnapshot(q, (querySnapshot) => {
            const suplementosData = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const colors = data.imagemPlaceholder ? extractColorsFromPlaceholder(data.imagemPlaceholder) : { bgColor: '#f3f4f6', textColor: '#374151' };
                suplementosData.push({ id: doc.id, ...data, colors });
            });
            suplementosData.sort((a, b) => a.nome.localeCompare(b.nome));
            setSuplementos(suplementosData);
            setLoading(false);
        }, (err) => {
            console.error("Erro ao buscar suplementos pessoais:", err);
            setError("Não foi possível carregar seus suplementos pessoais.");
            setLoading(false);
        });
        return () => unsubscribe();
    }, [db, userId, suplementosPessoaisCollectionPath]);

    const handleSelectSuplemento = (suplemento) => {
        setSelectedSuplemento(suplemento);
        setTimeout(() => {
            if (detalhesContainerRef.current) {
                const elementPosition = detalhesContainerRef.current.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerHeight;
                window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
            }
        }, 100);
    };
    
    const handleVoltarCatalogo = () => {
        setSelectedSuplemento(null);
        const catalogoHome = document.getElementById(id);
        if (catalogoHome) {
            const offsetPosition = catalogoHome.getBoundingClientRect().top + window.pageYOffset - headerHeight;
            window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
        }
    };

    if (loading) return <section id={id} className="py-20 md:py-24"><div className="container mx-auto px-4"><div className="loader-custom"></div><p className="text-center text-slate-600">Carregando catálogo pessoal...</p></div></section>;
    if (error) return <section id={id} className="py-20 md:py-24"><div className="container mx-auto px-4 text-center text-red-600"><AlertTriangle className="mx-auto h-10 w-10 mb-2" />{error}</div></section>;

    return (
        <section id={id} className="py-20 md:py-24 bg-rose-100"> 
            <div className="container mx-auto px-4">
                <h2 className="section-title-custom">Catálogo Pessoal</h2>
                <p className="section-title-subtle-custom">
                    Seus suplementos adicionados. Clique para ver detalhes ou vá para "Adicionar Suplemento" para incluir novos itens.
                </p>

                {!selectedSuplemento && (
                    <>
                        {suplementos.length === 0 ? (
                            <div className="text-center py-10">
                                <BookOpen size={48} className="mx-auto text-slate-400 mb-4" />
                                <p className="text-xl text-slate-600 mb-2">Seu catálogo pessoal está vazio.</p>
                                <p className="text-slate-500 mb-6">Adicione suplementos através da seção "Adicionar Novo Suplemento".</p>
                                <button onClick={(e) => onNavigate(e, 'adicionarSuplemento')} className="cta-button-catalogo-pessoal"> 
                                    <PlusCircle size={22} className="mr-2.5" />
                                    Adicionar Suplemento
                                </button>
                            </div>
                        ) : (
                            <div className="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-x-8 gap-y-10">
                                {suplementos.map(sup => (
                                    <div 
                                        key={sup.id} 
                                        className="suplemento-card-custom group" 
                                        style={{ backgroundColor: sup.colors?.bgColor || '#f3f4f6' }}
                                        onClick={() => handleSelectSuplemento(sup)}
                                    >
                                        <div className="suplemento-card-content-custom">
                                            <h3 
                                                className="suplemento-card-title-custom" 
                                                style={{ color: sup.colors?.textColor || '#374151' }}
                                            >
                                                {sup.nome}
                                            </h3>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </>
                )}

                {selectedSuplemento && (
                     <div ref={detalhesContainerRef} className="mt-16 md:mt-20">
                        <div className="suplemento-detalhe-content-custom">
                            <button onClick={handleVoltarCatalogo} className="voltar-catalogo-btn-custom">
                                <ChevronDown className="mr-2.5 h-5 w-5 transform -rotate-90" /> Voltar ao Catálogo Pessoal
                            </button>
                            <div 
                                className="suplemento-detalhe-header-block-custom"
                                style={{ backgroundColor: selectedSuplemento.colors?.bgColor || '#E11D48' }}
                            >
                                <h2 style={{ color: selectedSuplemento.colors?.textColor || '#FFFFFF' }}>{selectedSuplemento.nome}</h2>
                            </div>
                            <div className="content-box-custom">
                                <div className="grid md:grid-cols-3 gap-x-10 gap-y-8">
                                    <div className="md:col-span-1">
                                        <img 
                                            src={selectedSuplemento.imagemPlaceholder || 'https://placehold.co/500x667/cccccc/333333?text=Imagem+Indispon%C3%ADvel'} 
                                            alt={`Imagem de ${selectedSuplemento.nome}`}
                                            className="rounded-xl shadow-lg mb-6 w-full object-cover aspect-[3/4]"
                                            onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/500x667/cccccc/333333?text=Imagem+Indispon%C3%ADvel'; }}
                                        />
                                        <div className="disclaimer-box-custom">
                                            <p className="font-semibold">Lembre-se:</p>
                                            <p>Este conteúdo é informativo. Consulte um profissional de saúde antes de usar este suplemento.</p>
                                        </div>
                                    </div>
                                    <div 
                                        className="md:col-span-2 text-slate-700 leading-relaxed"
                                        dangerouslySetInnerHTML={{ __html: selectedSuplemento.htmlDetalhes || "<p>Informações detalhadas não disponíveis.</p>" }}
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </section>
    );
};


// Interaction Assistant Section
const AssistenteInteracoesSection = ({ id }) => {
    const [item1, setItem1] = useState('');
    const [item2, setItem2] = useState('');
    const [resultado, setResultado] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const resultadoRef = useRef(null);
    
    const apiKey = ""; 

    const handleVerificarInteracao = async () => {
        if (!item1 || !item2) {
            setResultado("<p class='text-red-600 font-medium'>Por favor, insira os dois itens para verificação.</p>");
            return;
        }
        if (item1.toLowerCase() === item2.toLowerCase()) {
            setResultado("<p class='text-orange-600 font-medium'>Você inseriu o mesmo item duas vezes. Por favor, insira dois itens diferentes.</p>");
            return;
        }

        setIsLoading(true);
        setResultado("<div class='loader-custom'></div><p class='text-center text-slate-600'>Analisando interação com IA... Por favor, aguarde.</p>");
        
        if (resultadoRef.current) {
            resultadoRef.current.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        const prompt = `Por favor, analise a possível interação medicamentosa e/ou alimentar entre "${item1}" e "${item2}". Descreva de forma clara e concisa: 1. A natureza da possível interação (exemplo: farmacocinética, farmacodinâmica, sinergia, antagonismo). 2. Os riscos potenciais ou efeitos adversos que podem surgir. 3. Recomendações gerais ou precauções a serem consideradas. 4. Se a combinação é geralmente considerada segura, de baixo risco, requer cautela, ou deve ser evitada. Enfatize que esta informação é para fins educativos, gerada por IA, e não substitui o aconselhamento de um profissional de saúde qualificado (médico, farmacêutico, nutricionista). Recomende fortemente a consulta a um profissional antes de tomar qualquer decisão sobre saúde ou tratamento. Formate a resposta com parágrafos curtos e use negrito para destacar os pontos chave (use tags HTML <strong> para negrito e <p> para parágrafos).`;
        
        let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
        const payload = { contents: chatHistory };
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        
        let mensagem = "";
        try {
            const response = await fetch(apiUrl, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(payload) 
            });

            if (!response.ok) {
                let errorDetails = `Erro HTTP: ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorDetails += ` - ${errorData.error?.message || JSON.stringify(errorData)}`;
                } catch (e) { /* Ignora erro ao parsear JSON do erro */ }
                throw new Error(errorDetails);
            }

            const result = await response.json();
            if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                let text = result.candidates[0].content.parts[0].text;
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                const formattedText = text.split('\n').map(paragraph => `<p>${paragraph}</p>`).join('');
                mensagem = `<h4 class='text-lg font-semibold text-red-700 mb-3'>Análise da Interação (Fornecida por IA):</h4><div class='space-y-3 text-sm prose-gemini'>${formattedText}</div>`;
            } else {
                mensagem = "<p class='text-orange-600 font-medium'>Não foi possível obter uma resposta da IA para esta combinação. Verifique os termos inseridos ou tente novamente mais tarde.</p>";
                if (result.promptFeedback && result.promptFeedback.blockReason) {
                    mensagem += `<p class='text-xs text-slate-500 mt-1'>Motivo do bloqueio pela IA: ${result.promptFeedback.blockReason}</p>`;
                }
            }
        } catch (error) {
            console.error("Erro ao chamar a API Gemini:", error);
            mensagem = `<p class='text-red-600 font-medium'>Ocorreu um erro ao tentar verificar a interação. Por favor, tente novamente mais tarde.</p><p class='text-xs text-slate-500 mt-1'>Detalhes do erro: ${error.message}</p>`;
        }
        setResultado(mensagem);
        setIsLoading(false);
    };

    return (
        <section id={id} className="py-20 md:py-24 bg-rose-100">
            <div className="container mx-auto px-4">
                <h2 className="section-title-custom text-3xl md:text-4xl lg:text-5xl font-extrabold">Assistente de Verificação de Interações (com IA Gemini)</h2>
                <p className="section-title-subtle-custom">Insira dois nomes (suplemento, medicamento ou alimento) para uma análise de possíveis interações fornecida por Inteligência Artificial.</p>
                <div className="assistente-form-container-custom">
                    <div className="grid sm:grid-cols-2 gap-x-6 gap-y-4 mb-8">
                        <div>
                            <label htmlFor="item1-interacao" className="block text-sm font-semibold text-slate-700 mb-1.5">Item 1 (Suplemento/Medicamento/Alimento):</label>
                            <input type="text" id="item1-interacao" value={item1} onChange={(e) => setItem1(e.target.value)} placeholder="Ex: Ômega 3" className="mt-1 block w-full rounded-xl border-slate-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 sm:text-base p-3.5 transition-all duration-200" />
                        </div>
                        <div>
                            <label htmlFor="item2-interacao" className="block text-sm font-semibold text-slate-700 mb-1.5">Item 2 (Suplemento/Medicamento/Alimento):</label>
                            <input type="text" id="item2-interacao" value={item2} onChange={(e) => setItem2(e.target.value)} placeholder="Ex: Varfarina" className="mt-1 block w-full rounded-xl border-slate-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 sm:text-base p-3.5 transition-all duration-200" />
                        </div>
                    </div>
                    <button onClick={handleVerificarInteracao} disabled={isLoading} className="w-full sm:w-auto cta-button-custom">
                        <Sparkles size={20} className="mr-2 inline" />
                        {isLoading ? 'Analisando...' : 'Analisar Interação com IA'}
                    </button>
                    {resultado && (
                        <div ref={resultadoRef} className="assistente-resultado-container-custom mt-10" dangerouslySetInnerHTML={{ __html: resultado }} />
                    )}
                    <div className="disclaimer-box-strong-custom mt-10">
                        <p className="text-xl md:text-2xl font-bold text-pink-800">⚠️ Ferramenta Educacional Avançada:</p>
                        <p className="mt-2">Este assistente utiliza Inteligência Artificial (IA Gemini) para fornecer uma análise sobre possíveis interações. As informações geradas são para fins <strong>educativos e informativos</strong>.</p>
                        <p className="mt-2"><strong>Esta análise NÃO substitui o aconselhamento de um profissional de saúde.</strong></p>
                        <p className="mt-2"><strong>Sempre discuta todas as suas medicações e suplementos com seus profissionais de saúde.</strong></p>
                    </div>
                </div>
            </div>
        </section>
    );
};

// Nutritional Calculator Section
const CalculadoraNutricionalSection = ({ id }) => {
    const [formData, setFormData] = useState({
        idade: 30, sexo: 'masculino', peso: 70, altura: 175, atividade: '1.55'
    });
    const [resultados, setResultados] = useState(null);
    const resultadoRef = useRef(null);

    const handleChange = (e) => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        const { idade, sexo, peso, altura, atividade } = formData;
        const numIdade = parseInt(idade);
        const numPeso = parseFloat(peso);
        const numAltura = parseInt(altura);
        const numAtividade = parseFloat(atividade);

        if (isNaN(numIdade) || isNaN(numPeso) || isNaN(numAltura) || !sexo || !numAtividade || numIdade <=0 || numPeso <=0 || numAltura <=0) {
            setResultados({ error: "Por favor, preencha todos os campos com valores válidos." });
            return;
        }
        
        let tmb;
        if (sexo === 'masculino') {
            tmb = (10 * numPeso) + (6.25 * numAltura) - (5 * numIdade) + 5;
        } else {
            tmb = (10 * numPeso) + (6.25 * numAltura) - (5 * numIdade) - 161;
        }
        const get = tmb * numAtividade;
        const proteinasCalorias = get * 0.30; 
        const proteinasGramas = proteinasCalorias / 4;
        const gordurasCalorias = get * 0.30; 
        const gordurasGramas = gordurasCalorias / 9;
        const carboidratosCalorias = get * 0.40; 
        const carboidratosGramas = carboidratosCalorias / 4;

        setResultados({
            tmb: tmb.toFixed(0),
            get: get.toFixed(0),
            proteinasGramas: proteinasGramas.toFixed(0),
            proteinasCalorias: proteinasCalorias.toFixed(0),
            gordurasGramas: gordurasGramas.toFixed(0),
            gordurasCalorias: gordurasCalorias.toFixed(0),
            carboidratosGramas: carboidratosGramas.toFixed(0),
            carboidratosCalorias: carboidratosCalorias.toFixed(0),
            error: null
        });

        if (resultadoRef.current) {
            setTimeout(() => resultadoRef.current.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
        }
    };

    return (
        <section id={id} className="py-20 md:py-24">
            <div className="container mx-auto px-4">
                <h2 className="section-title-custom text-red-700 text-3xl md:text-4xl lg:text-5xl font-extrabold">Assistente de Estimativas Nutricionais</h2>
                <p className="section-title-subtle-custom">Preencha os campos abaixo para obter uma estimativa de suas necessidades calóricas e de macronutrientes.</p>
                <div className="assistente-form-container-custom">
                    <form onSubmit={handleSubmit} className="space-y-6">
                        <div className="grid sm:grid-cols-2 gap-x-6 gap-y-4">
                            <div>
                                <label htmlFor="idade-nutricao" className="block text-sm font-semibold text-slate-700 mb-1.5">Idade (anos):</label>
                                <input type="number" name="idade" id="idade-nutricao" value={formData.idade} onChange={handleChange} placeholder="Ex: 30" required min="1" max="120" className="mt-1 block w-full rounded-xl border-slate-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 sm:text-base p-3.5 transition-all duration-200" />
                            </div>
                            <div>
                                <label htmlFor="sexo-nutricao" className="block text-sm font-semibold text-slate-700 mb-1.5">Sexo Biológico:</label>
                                <select name="sexo" id="sexo-nutricao" value={formData.sexo} onChange={handleChange} required className="mt-1 block w-full rounded-xl border-slate-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 sm:text-base p-3.5 transition-all duration-200">
                                    <option value="masculino">Masculino</option>
                                    <option value="feminino">Feminino</option>
                                </select>
                            </div>
                        </div>
                        <div className="grid sm:grid-cols-2 gap-x-6 gap-y-4">
                            <div>
                                <label htmlFor="peso-nutricao" className="block text-sm font-semibold text-slate-700 mb-1.5">Peso (kg):</label>
                                <input type="number" name="peso" id="peso-nutricao" value={formData.peso} onChange={handleChange} step="0.1" placeholder="Ex: 70.5" required min="1" className="mt-1 block w-full rounded-xl border-slate-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 sm:text-base p-3.5 transition-all duration-200" />
                            </div>
                            <div>
                                <label htmlFor="altura-nutricao" className="block text-sm font-semibold text-slate-700 mb-1.5">Altura (cm):</label>
                                <input type="number" name="altura" id="altura-nutricao" value={formData.altura} onChange={handleChange} placeholder="Ex: 175" required min="1" className="mt-1 block w-full rounded-xl border-slate-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 sm:text-base p-3.5 transition-all duration-200" />
                            </div>
                        </div>
                        <div>
                            <label htmlFor="atividade-nutricao" className="block text-sm font-semibold text-slate-700 mb-1.5">Nível de Atividade Física:</label>
                            <select name="atividade" id="atividade-nutricao" value={formData.atividade} onChange={handleChange} required className="mt-1 block w-full rounded-xl border-slate-300 shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 sm:text-base p-3.5 transition-all duration-200">
                                <option value="1.2">Sedentário (pouco ou nenhum exercício)</option>
                                <option value="1.375">Levemente Ativo (exercício leve 1-3 dias/semana)</option>
                                <option value="1.55">Moderadamente Ativo (exercício moderado 3-5 dias/semana)</option>
                                <option value="1.725">Muito Ativo (exercício intenso 6-7 dias/semana)</option>
                                <option value="1.9">Extremamente Ativo (exercício muito intenso, trabalho físico)</option>
                            </select>
                        </div>
                        <button type="submit" className="w-full sm:w-auto cta-button-custom">
                            <Calculator size={20} className="mr-2 inline" /> Calcular Estimativas
                        </button>
                    </form>
                    {resultados && (
                        <div ref={resultadoRef} className="assistente-resultado-container-custom mt-10">
                            {resultados.error ? <p className="text-red-600 font-medium">{resultados.error}</p> : (
                                <>
                                    <h4 className='text-xl font-bold text-red-700 mb-4'>Suas Estimativas Nutricionais:</h4>
                                    <div className='space-y-2 text-slate-700'>
                                        <p><strong>Taxa Metabólica Basal (TMB):</strong> <span className='font-semibold text-red-600'>{resultados.tmb} kcal/dia</span></p>
                                        <p><strong>Gasto Energético Total (GET) Estimado:</strong> <span className='font-semibold text-red-600'>{resultados.get} kcal/dia</span></p>
                                    </div>
                                    <h5 className='text-lg font-semibold text-red-600 mt-6 mb-3'>Sugestão de Distribuição de Macronutrientes (Exemplo 40C/30P/30G):</h5>
                                    <ul className='list-none space-y-2 text-slate-700'>
                                        <li><strong>Carboidratos:</strong> {resultados.carboidratosGramas}g (<span className='text-sm'>{resultados.carboidratosCalorias} kcal</span>) - <span className='font-medium text-rose-600'>~40%</span></li>
                                        <li><strong>Proteínas:</strong> {resultados.proteinasGramas}g (<span className='text-sm'>{resultados.proteinasCalorias} kcal</span>) - <span className='font-medium text-rose-600'>~30%</span></li>
                                        <li><strong>Gorduras:</strong> {resultados.gordurasGramas}g (<span className='text-sm'>{resultados.gordurasCalorias} kcal</span>) - <span className='font-medium text-rose-600'>~30%</span></li>
                                    </ul>
                                    <p className='mt-6 text-xs text-slate-500 leading-normal'><strong>Nota Importante:</strong> Esta é uma distribuição de exemplo. Consulte um nutricionista.</p>
                                </>
                            )}
                        </div>
                    )}
                    <div className="disclaimer-box-strong-custom mt-10">
                        <p className="text-xl md:text-2xl font-bold text-pink-800">⚠️ Ferramenta Educacional - Estimativas:</p>
                        <p className="mt-2">Os cálculos são <strong>estimativas gerais</strong>. Suas necessidades reais podem variar. <strong>NÃO utilize como plano nutricional ou substituto para aconselhamento profissional.</strong></p>
                    </div>
                </div>
            </div>
        </section>
    );
};

// Adicionar Novo Suplemento Section (Formerly AdminDashboardSection)
const AdicionarSuplementoSection = ({ id, db, userId }) => {
    const [isLoading, setIsLoading] = useState(false); 
    const [error, setError] = useState(null); 
    const [showForm, setShowForm] = useState(true); 
    const [editingSuplemento, setEditingSuplemento] = useState(null); 
    
    const initialFormState = {
        nome: '',
        imagemPlaceholder: 'https://placehold.co/600x400/E11D48/FFFFFF?text=Novo+Suplemento',
        htmlDetalhes: `<h3>O que é?</h3>\n<p>Descrição básica do suplemento.</p>\n\n<h4>Principais Benefícios</h4>\n<ul>\n  <li>Benefício 1</li>\n  <li>Benefício 2</li>\n</ul>\n\n<h4>Posologia Comum</h4>\n<p>Informação sobre dosagem.</p>\n\n<div class="disclaimer-box-strong-custom mt-8">\n  <p>Consulte um profissional de saúde.</p>\n</div>`,
    };
    const [formData, setFormData] = useState(initialFormState);

    const suplementosPessoaisCollectionPath = `artifacts/${appId}/public/data/suplementos`;

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };
    
    const handleEdit = (suplemento) => {
        setEditingSuplemento(suplemento);
        setFormData({
            nome: suplemento.nome || '',
            imagemPlaceholder: suplemento.imagemPlaceholder || initialFormState.imagemPlaceholder,
            htmlDetalhes: suplemento.htmlDetalhes || initialFormState.htmlDetalhes,
        });
        setShowForm(true); 
    };


    const handleSubmitForm = async (e) => {
        e.preventDefault();
        setError(null); 
        if (!formData.nome) {
            setError("O nome do suplemento é obrigatório.");
            alert("O nome do suplemento é obrigatório."); 
            return;
        }
        setIsLoading(true);
        const dataToSave = { ...formData };

        try {
            if (editingSuplemento) { 
                const docRef = doc(db, suplementosPessoaisCollectionPath, editingSuplemento.id);
                await updateDoc(docRef, dataToSave);
                alert("Suplemento atualizado com sucesso no Catálogo Pessoal!");
            } else { 
                const q = query(collection(db, suplementosPessoaisCollectionPath), where("nome", "==", dataToSave.nome));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    setError("Já existe um suplemento com este nome no Catálogo Pessoal.");
                    alert("Já existe um suplemento com este nome no Catálogo Pessoal.");
                    setIsLoading(false);
                    return;
                }
                await addDoc(collection(db, suplementosPessoaisCollectionPath), dataToSave);
                alert("Suplemento adicionado com sucesso ao Catálogo Pessoal!");
            }
            setEditingSuplemento(null);
            setFormData(initialFormState); 
        } catch (err) {
            console.error("Erro ao salvar suplemento:", err);
            setError("Erro ao salvar suplemento: " + err.message);
            alert("Erro ao salvar suplemento: " + err.message);
        } finally {
            setIsLoading(false);
        }
    };
    
    const FormInputAdmin = ({ label, name, value, onChange, type = "text", rows, icon }) => (
        <div>
            <label htmlFor={name} className="block text-sm font-semibold text-slate-700 mb-1.5 flex items-center">
                {icon && React.cloneElement(icon, { size: 16, className: "mr-2 text-slate-500" })} {label}
            </label>
            {type === "textarea" ? (
                <textarea id={name} name={name} value={value || ''} onChange={onChange} rows={rows || 6} className="w-full p-3 border border-slate-300 rounded-xl shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 sm:text-base transition-all duration-200"></textarea>
            ) : (
                <input type={type} id={name} name={name} value={value || ''} onChange={onChange} className="w-full p-3 border border-slate-300 rounded-xl shadow-sm focus:border-red-500 focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 sm:text-base transition-all duration-200" />
            )}
        </div>
    );

    return (
        <section id={id} className="py-20 md:py-24 bg-slate-50"> 
            <div className="container mx-auto px-4">
                <h2 className="section-title-custom text-red-700 text-3xl md:text-4xl lg:text-5xl font-extrabold">Adicionar Novo Suplemento</h2>
                <p className="section-title-subtle-custom">
                    Preencha os dados abaixo para adicionar um suplemento ao seu "Catálogo Pessoal".
                </p>

                <div className="assistente-form-container-custom"> 
                    <form onSubmit={handleSubmitForm} className="space-y-5">
                        <h3 className="text-2xl font-semibold text-red-700 mb-6 text-center">{editingSuplemento ? 'Editar Suplemento Existente' : 'Criar Novo Suplemento Pessoal'}</h3>
                        {error && <p className="text-sm text-red-600 bg-red-100 p-3 rounded-md text-center">{error}</p>}
                        
                        <FormInputAdmin label="Nome do Suplemento" name="nome" value={formData.nome} onChange={handleInputChange} icon={<Leaf />} />
                        <FormInputAdmin 
                            label="URL da Imagem Placeholder" 
                            name="imagemPlaceholder" 
                            value={formData.imagemPlaceholder} 
                            onChange={handleInputChange} 
                            icon={<ImagePlaceholderIcon />} 
                        />
                        <p className="text-xs text-slate-500 -mt-3">
                            Use o formato: <code>https://placehold.co/600x400/COR_FUNDO_HEX/COR_TEXTO_HEX?text=Nome</code><br/>
                            Exemplo para fundo vermelho e texto branco: <code>https://placehold.co/600x400/E11D48/FFFFFF?text=Meu+Suplem</code>
                        </p>
                        <FormInputAdmin 
                            label="HTML dos Detalhes" 
                            name="htmlDetalhes" 
                            value={formData.htmlDetalhes} 
                            onChange={handleInputChange} 
                            type="textarea" 
                            rows="12" 
                            icon={<AlignLeft />} 
                        />
                        <p className="text-xs text-slate-500 -mt-3">
                            Use tags HTML como <code>&lt;h3&gt;</code>, <code>&lt;p&gt;</code>, <code>&lt;ul&gt;</code>, <code>&lt;li&gt;</code>. 
                            Ex: <code>&lt;h3&gt;O que é?&lt;/h3&gt;&lt;p&gt;Descrição...&lt;/p&gt;</code>
                        </p>

                        <div className="flex justify-end space-x-3 pt-5">
                            {editingSuplemento && (
                                <button type="button" onClick={() => { setEditingSuplemento(null); setFormData(initialFormState); setError(null); }} className="px-6 py-2.5 text-slate-700 bg-slate-200 hover:bg-slate-300 rounded-lg font-medium text-sm">
                                    Cancelar Edição
                                </button>
                            )}
                            <button type="submit" disabled={isLoading} className="cta-button-custom !bg-green-600 hover:!bg-green-700">
                                {isLoading ? (editingSuplemento ? 'Salvando...' : 'Adicionando...') : (editingSuplemento ? 'Salvar Alterações' : 'Adicionar ao Catálogo Pessoal')}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    );
};

const ImagePlaceholderIcon = (props) => <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>;


// Footer Section
const FooterSection = ({ id }) => {
    const currentYear = new Date().getFullYear();
    return (
        <footer id={id} className="bg-slate-900 text-slate-400 py-20">
            <div className="container mx-auto px-4">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-x-10 gap-y-12 mb-12">
                    <div>
                        <h5 className="text-xl font-bold text-white mb-5">FarNutri</h5>
                        <p className="text-sm leading-relaxed">Seu guia suplementativo. Nosso objetivo é fornecer dados claros, detalhados e baseados em evidências, sempre incentivando o acompanhamento profissional qualificado.</p>
                    </div>
                    <div>
                        <h5 className="text-xl font-bold text-white mb-5">Links Rápidos</h5>
                        <ul className="space-y-2.5 text-sm">
                            <li><a href="#inicio" className="hover:text-red-400 transition-colors">Início</a></li>
                            <li><a href="#biblioteca" className="hover:text-red-400 transition-colors">Biblioteca</a></li>
                            <li><a href="#catalogoPessoal" className="hover:text-red-400 transition-colors">Catálogo Pessoal</a></li>
                            <li><a href="#interacoes" className="hover:text-red-400 transition-colors">Interações (IA)</a></li>
                            <li><a href="#nutricao" className="hover:text-red-400 transition-colors">Nutrição</a></li>
                            <li><a href="https://www.gov.br/anvisa/pt-br" target="_blank" rel="noopener noreferrer" className="hover:text-red-400 transition-colors">ANVISA (Site Oficial)</a></li>
                        </ul>
                    </div>
                    <div>
                        <h5 className="text-xl font-bold text-white mb-5">Aviso Legal Fundamental</h5>
                        <p className="text-sm leading-relaxed">As informações contidas neste site são para fins educacionais e não substituem aconselhamento profissional qualificado.</p>
                        <p className="text-sm mt-3 leading-relaxed">Sempre procure o aconselhamento de seu médico ou outro profissional de saúde qualificado.</p>
                    </div>
                </div>
                <div className="mt-16 border-t border-slate-700 pt-10 text-center text-xs">
                    <p>&copy; {currentYear} FarNutri. Todos os direitos reservados.</p>
                     {auth?.currentUser?.uid && <p className="text-slate-600 mt-1">ID Usuário: {auth.currentUser.uid}</p>}
                </div>
            </div>
        </footer>
    );
};


// Main App Component
const App = () => {
    const [currentSection, setCurrentSection] = useState('inicio');
    const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [userId, setUserId] = useState(null);
    const headerRef = useRef(null);
    const [headerHeight, setHeaderHeight] = useState(0);

    useEffect(() => {
        if (headerRef.current) {
            setHeaderHeight(headerRef.current.offsetHeight);
        }
    }, [isMobileMenuOpen]); 

    useEffect(() => {
        if (!auth) {
            console.warn("Firebase Auth não inicializado.");
            setIsAuthReady(true); 
            setUserId(crypto.randomUUID()); 
            return;
        }
        const unsubscribe = onAuthStateChanged(auth, async (user) => {
            if (user) {
                setUserId(user.uid);
            } else {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    setUserId(auth.currentUser ? auth.currentUser.uid : crypto.randomUUID());
                } catch (error) {
                    console.error("Erro ao autenticar:", error);
                    setUserId(crypto.randomUUID()); 
                }
            }
            setIsAuthReady(true);
        });
        return () => unsubscribe();
    }, []);

    const handleNavigate = (event, sectionId) => {
        event.preventDefault();
        const element = document.getElementById(sectionId);
        if (element) {
            const elementPosition = element.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - headerHeight;
            window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
            });
        }
        if (isMobileMenuOpen) setIsMobileMenuOpen(false);
    };
    
    useEffect(() => {
        const sections = ['inicio', 'biblioteca', 'catalogoPessoal', 'interacoes', 'nutricao', 'adicionarSuplemento', 'sobre'];
        
        const topMarginValue = -(headerHeight + 40);
        const bottomVisibleArea = 100; 
        const bottomMarginValue = -(window.innerHeight - headerHeight - bottomVisibleArea);
        const currentRootMargin = `${topMarginValue}px 0px ${bottomMarginValue}px 0px`;

        const observerOptions = {
            root: null,
            rootMargin: currentRootMargin,
            threshold: 0.01 
        };

        const observerCallback = (entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const rect = entry.target.getBoundingClientRect();
                    const isTopVisible = rect.top >= headerHeight && rect.top < window.innerHeight / 2;
                    if(isTopVisible || (rect.height > window.innerHeight && rect.top < headerHeight && rect.bottom > window.innerHeight /2) ){
                        setCurrentSection(entry.target.id);
                    }
                }
            });
        };
        
        let observer;
        try {
            observer = new IntersectionObserver(observerCallback, observerOptions);
            sections.forEach(id => {
                const element = document.getElementById(id);
                if (element) observer.observe(element);
            });
        } catch (e) {
            console.error("Failed to construct IntersectionObserver:", e);
            // Fallback or simply don't observe if constructor fails
            // This might happen if rootMargin is invalid due to extreme values during initial render.
        }


        return () => {
            if(observer) observer.disconnect();
        }
    }, [headerHeight]);


    if (!isAuthReady) {
        return (
            <div className="flex flex-col items-center justify-center min-h-screen bg-rose-50">
                <div className="loader-custom"></div>
                <p className="mt-4 text-slate-700 text-lg">Carregando FarNutri...</p>
            </div>
        );
    }
    
    return (
        <>
            <GlobalStyles />
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
            <div className="flex flex-col min-h-screen">
                <Header 
                    currentSection={currentSection} 
                    onNavigate={handleNavigate}
                    isMobileMenuOpen={isMobileMenuOpen}
                    setIsMobileMenuOpen={setIsMobileMenuOpen}
                    headerRef={headerRef}
                />
                <main className="flex-grow">
                    <HeroSection id="inicio" onNavigate={handleNavigate} />
                    <BibliotecaSection id="biblioteca" onNavigate={handleNavigate} headerHeight={headerHeight} />
                    <CatalogoPessoalSection id="catalogoPessoal" db={db} userId={userId} onNavigate={handleNavigate} headerHeight={headerHeight} />
                    <AssistenteInteracoesSection id="interacoes" />
                    <CalculadoraNutricionalSection id="nutricao" />
                    {db && userId && <AdicionarSuplementoSection id="adicionarSuplemento" db={db} userId={userId} />}
                    <FooterSection id="sobre" />
                </main>
            </div>
        </>
    );
};

export default App;

